# Directories
SRC_DIR := src
BUILD_DIR := build
DATA_DIR := data
INCLUDES := includes

# Program configuration
PROG := queue
TARGET := $(BUILD_DIR)/$(PROG)

# Compiler and tools
CXX := g++
RM := rm -rf
MKDIR := mkdir -p

# Source files (automatically find all .cpp files)
SRC := $(wildcard $(SRC_DIR)/*.cpp)
OBJ := $(patsubst $(SRC_DIR)/%.cpp,$(BUILD_DIR)/%.o,$(SRC))
DEPS := $(OBJ:.o=.d)

# Compiler flags
CXXFLAGS := -std=c++23 -MMD -MP
CXXFLAGS += -Wall -Wextra -Wpedantic -Wshadow -Wconversion

# Performance optimization flags
CXXFLAGS += -O3 -march=native -mtune=native
CXXFLAGS += -flto -ffast-math
CXXFLAGS += -funroll-loops -finline-functions
CXXFLAGS += -DNDEBUG  # Disable assertions in release mode

# OpenMP support
CXXFLAGS += -fopenmp

# Include directories
CXXFLAGS += -I$(INCLUDES)

# Linker flags
LDFLAGS := -fopenmp -flto
LDLIBS := -lpthread

# Build modes (use: make DEBUG=1 for debug build)
ifdef DEBUG
    CXXFLAGS := $(filter-out -O3 -DNDEBUG -ffast-math,$(CXXFLAGS))
    CXXFLAGS += -O0 -g3 -DDEBUG -fsanitize=address -fsanitize=undefined
    LDFLAGS += -fsanitize=address -fsanitize=undefined
endif

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m  # No Color

# ============================================================================
# TARGETS
# ============================================================================

.PHONY: all clean run info help small-bench bench small-plot report zip

# Default target
all: $(TARGET)
	@echo "$(GREEN)✓ Build complete: $(TARGET)$(NC)"

# Link the executable
$(TARGET): $(OBJ) | $(BUILD_DIR)
	@echo "$(BLUE)Linking $(PROG)...$(NC)"
	$(CXX) $(OBJ) $(LDFLAGS) $(LDLIBS) -o $@

# Compile source files to object files
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@echo "$(YELLOW)Compiling $<...$(NC)"
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Create build directory if it doesn't exist
$(BUILD_DIR):
	@echo "$(BLUE)Creating build directory...$(NC)"
	$(MKDIR) $(BUILD_DIR)

# Include dependency files (auto-generated by -MMD)
-include $(DEPS)

# ============================================================================
# UTILITY TARGETS
# ============================================================================

# Clean build artifacts
clean:
	@echo "$(RED)Cleaning build artifacts...$(NC)"
	$(RM) $(BUILD_DIR)

# Clean and rebuild
rebuild: clean all

# Run the program
run: $(TARGET)
	@echo "$(GREEN)Running $(PROG)...$(NC)"
	@./$(TARGET)

# Show build information
info:
	@echo "$(BLUE)═══════════════════════════════════════════$(NC)"
	@echo "$(BLUE)Build Configuration$(NC)"
	@echo "$(BLUE)═══════════════════════════════════════════$(NC)"
	@echo "Compiler:      $(CXX)"
	@echo "Target:        $(TARGET)"
	@echo "Source files:  $(SRC)"
	@echo "Object files:  $(OBJ)"
	@echo "CXXFLAGS:      $(CXXFLAGS)"
	@echo "LDFLAGS:       $(LDFLAGS)"
	@echo "$(BLUE)═══════════════════════════════════════════$(NC)"

# Help message
help:
	@echo "$(GREEN)Available targets:$(NC)"
	@echo "  make          - Build the executable (default)"
	@echo "  make clean    - Remove all build artifacts"
	@echo "  make rebuild  - Clean and rebuild"
	@echo "  make run      - Build and run the program"
	@echo "  make info     - Show build configuration"
	@echo "  make DEBUG=1  - Build with debug symbols and sanitizers"
	@echo "  make help     - Show this help message"


# ============================================
# Benchmark Parameters
# ============================================
MAX_TIME ?= 1
REPETITIONS ?= 1
OUTPUT_FILE ?= results.csv
BATCH_SIZE ?= 1000

# Thread counts (renamed for clarity)
THREADS_WITH_SEQUENTIAL ?= 1 2 8 10 20 32 45 64
THREADS_MULTI_ONLY ?= 2 8 10 20 32 45 64

# ============================================
# Benchmark Targets
# ============================================

small-bench-balanced: $(BUILD_DIR) $(DATA_DIR)
	@echo "Running balanced benchmark → $(DATA_DIR)/$(OUTPUT_FILE)"
	@echo "  MAX_TIME=$(MAX_TIME), BATCH_SIZE=$(BATCH_SIZE), REPETITIONS=$(REPETITIONS)"
	
	@echo "Running sequential (baseline)..."
	./$(TARGET) --type sequential --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --print_header >> $(DATA_DIR)/$(OUTPUT_FILE)
	
	@echo "Running global_lock..."
	@for threads in $(THREADS_WITH_SEQUENTIAL); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type global_lock >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "Running fine_lock..."
	@for threads in $(THREADS_WITH_SEQUENTIAL); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type fine_lock >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "Running lock_free..."
	@for threads in $(THREADS_WITH_SEQUENTIAL); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type lock_free >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "✓ Balanced benchmark complete!"

small-bench-thread: $(BUILD_DIR) $(DATA_DIR)
	@echo "Running thread-specific benchmark → $(DATA_DIR)/$(OUTPUT_FILE)"
	
	@echo "Running global_lock..."
	@for threads in $(THREADS_MULTI_ONLY); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type global_lock --config_recipe thread >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "Running fine_lock..."
	@for threads in $(THREADS_MULTI_ONLY); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type fine_lock --config_recipe thread >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "Running lock_free..."
	@for threads in $(THREADS_MULTI_ONLY); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type lock_free --config_recipe thread >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "✓ Thread-specific benchmark complete!"

small-bench-even-odd: $(BUILD_DIR) $(DATA_DIR)
	@echo "Running even-odd benchmark → $(DATA_DIR)/$(OUTPUT_FILE)"
	
	@echo "Running global_lock..."
	@for threads in $(THREADS_MULTI_ONLY); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type global_lock --config_recipe evenodd >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "Running fine_lock..."
	@for threads in $(THREADS_MULTI_ONLY); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type fine_lock --config_recipe evenodd >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "Running lock_free..."
	@for threads in $(THREADS_MULTI_ONLY); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type lock_free --config_recipe evenodd >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "✓ Even-odd benchmark complete!"

small-bench-onetoall: $(BUILD_DIR) $(DATA_DIR)
	@echo "Running one-to-all benchmark → $(DATA_DIR)/$(OUTPUT_FILE)"
	
	@echo "Running sequential (baseline)..."
	./$(TARGET) --type sequential --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --print_header >> $(DATA_DIR)/$(OUTPUT_FILE)
	
	@echo "Running global_lock..."
	@for threads in $(THREADS_WITH_SEQUENTIAL); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type global_lock --config_recipe onetoall >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "Running fine_lock..."
	@for threads in $(THREADS_WITH_SEQUENTIAL); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type fine_lock --config_recipe onetoall >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "Running lock_free..."
	@for threads in $(THREADS_WITH_SEQUENTIAL); do \
		./$(TARGET) --n_threads $$threads --repetitions $(REPETITIONS) --max_time $(MAX_TIME) --batch_size $(BATCH_SIZE) --type lock_free --config_recipe onetoall >> $(DATA_DIR)/$(OUTPUT_FILE); \
	done
	
	@echo "✓ One-to-all benchmark complete!"

# Make these targets phony (not actual files)
.PHONY: small-bench-balanced small-bench-thread small-bench-even-odd small-bench-onetoall


bench-perf: $(BUILD_DIR) $(DATA_DIR)
	@echo "Running small-bench ..."
	@echo "Running sequential ..."
	./$(TARGET) --type sequential --print_header  >> $(DATA_DIR)/"results_small_bench.csv";

	@echo "Running global lock"
	@for threads in 1 2 4 8; do \
		perf stat ./$(TARGET) --n_threads $$threads --repetitions 1 --max_time 1 --type global_lock --config_recipe balanced>> $(DATA_DIR)/"perf_bench.txt"; \
	done

	@echo "Running fine lock"
	@for threads in 1 2 4 8; do \
		perf stat ./$(TARGET) --n_threads $$threads --repetitions 1 --max_time 1 --type fine_lock  --config_recipe balanced>> $(DATA_DIR)/"perf_bench.txt"; \
	done

	@echo "Running lock_free"
	@for threads in 1 2 4 8; do \
		perf stat ./$(TARGET) --n_threads $$threads --repetitions 1 --max_time 1 --type lock_free  --config_recipe balanced>> $(DATA_DIR)/"perf_bench.txt"; \
	done

small-plot:
	@echo "Plotting small-bench results ..."
	bash -c 'cd plots && pdflatex "\newcommand{\DATAPATH}{../data/$$(ls ../data/ | sort -r | head -n 1)}\input{avg_plot.tex}"'
	@echo "============================================"
	@echo "Created plots/avgplot.pdf"

report: small-plot
	@echo "Compiling report ..."
	bash -c 'cd report && pdflatex report.tex'
	@echo "============================================"
	@echo "Done"

zip:
	@zip project.zip benchmark.py Makefile README src/* plots/avg_plot.tex report/report.tex run_nebula.sh
